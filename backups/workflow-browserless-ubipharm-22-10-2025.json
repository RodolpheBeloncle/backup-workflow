{"createdAt":"2025-09-24T12:49:54.044Z","updatedAt":"2025-10-22T12:46:14.445Z","id":"isjhKyi99x2adke0","name":"browserless-ubipharm","active":false,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-64,144],"id":"f2598a13-ad26-4f19-8810-6eafe18aea5e","name":"When clicking ‚ÄòExecute workflow‚Äô"},{"parameters":{"method":"POST","url":"https://production-sfo.browserless.io/function","sendQuery":true,"queryParameters":{"parameters":[{"name":"token"}]},"sendBody":true,"contentType":"raw","rawContentType":"application/javascript","body":"export default async ({ page, context }) => {\n  try {\n    const login = context?.login || \"biogaran\";\n    const password = context?.password || \"Biogaran2021\";\n\n    // Configuration de la vue pour √©viter les probl√®mes d'affichage\n    await page.setViewport({ width: 1920, height: 1080 });\n\n    // Connexion\n    await page.goto(\"https://fournisseur-benin.ubipharm.com\", { waitUntil: \"networkidle2\" });\n    \n    // Remplir le formulaire\n    await page.type('input[name=\"Login\"]', login);\n    await page.type('input[name=\"Password\"]', password);\n    \n    // Cliquer sur le bouton de connexion\n    await page.click('button[type=\"submit\"]');\n    \n    // aller √† la page des statistiques\n    await page.goto(\"https://fournisseur-benin.ubipharm.com/StatsVentes\", { waitUntil: \"networkidle2\" });\n\n    // !! attention code a modifier\n\n       // ‚ö° R√©cup√©rer les donn√©es CSV/Excel\n    // const fileContent = await page.evaluate(async () => {\n    //     try {\n    //         // Essayer de r√©cup√©rer via l'endpoint API ou le t√©l√©chargement\n    //         const response = await fetch(\"/StatsVentes?exportcsv=O\", {\n    //             method: \"GET\",\n    //             credentials: \"include\"\n    //         });\n            \n    //         if (response.ok) {\n    //             return await response.text();\n    //         } else {\n    //             // Alternative : cliquer sur le bouton d'export s'il existe\n    //             const exportBtn = document.querySelector('.exportcsv\"]');\n    //             if (exportBtn) {\n    //                 exportBtn.click();\n    //                 // Ici il faudrait g√©rer le t√©l√©chargement du fichier\n    //                 return \"export_triggered\";\n    //             }\n    //             throw new Error(`HTTP error! status: ${response.status}`);\n    //         }\n    //     } catch (error) {\n    //         console.error(\"Fetch error:\", error);\n    //         return null;\n    //     }\n    // });\n\n    // üî• SOLUTION 2: R√©cup√©ration directe du fichier binaire\n    const fileContent = await page.evaluate(async () => {\n      try {\n        // Faire la requ√™te pour r√©cup√©rer le fichier\n        const response = await fetch(\"/StatsVentes?exportcsv=O\", {\n          method: \"GET\",\n          credentials: \"include\"\n        });\n                    \n        if (!response.ok) {\n          throw new Error(`HTTP error! status: ${response.status}`);\n        }\n\n        // üéØ POINT CL√â: Utiliser arrayBuffer() pour les donn√©es binaires\n        const arrayBuffer = await response.arrayBuffer();\n        \n        // Convertir en Base64 pour le transport\n        const uint8Array = new Uint8Array(arrayBuffer);\n        const base64String = btoa(String.fromCharCode(...uint8Array));\n        \n        // R√©cup√©rer les headers pour d√©terminer le type de fichier\n        const contentType = response.headers.get('content-type') || 'application/octet-stream';\n        const contentDisposition = response.headers.get('content-disposition') || '';\n        \n        // Extraire le nom du fichier depuis Content-Disposition\n        let filename = 'export.csv';\n        const filenameMatch = contentDisposition.match(/filename[^;=\\n]*=((['\"]).*?\\2|[^;\\n]*)/);\n        if (filenameMatch) {\n          filename = filenameMatch[1].replace(/['\"]/g, '');\n        }\n\n        return {\n          fileContent: base64String,\n          contentType: contentType,\n          filename: filename,\n          size: arrayBuffer.byteLength\n        };\n\n      } catch (error) {\n        console.error(\"Fetch error:\", error);\n        return { error: error.message };\n      }\n    });\n\n    // V√©rifier si on a r√©cup√©r√© le fichier avec succ√®s\n    if (fileContent.error) {\n      throw new Error(fileData.error);\n    }\n\n\n\n    return {\n        data: {\n            success: true,\n            message: \"CSV t√©l√©charg√© avec succ√®s\",\n            csvContent: fileContent,\n            currentUrl: page.url(),\n        },\n        type: \"application/json\",\n    };\n  } catch (err) {\n    const errorScreenshot = await page.screenshot({ fullPage: true });\n    const errorScreenshotBase64 = errorScreenshot.toString(\"base64\");\n\n    return {\n        data: {\n            success: false,\n            error: err.message,\n            screenshot: errorScreenshotBase64,\n            currentUrl: page.url(),\n        },\n        type: \"application/json\",\n    };\n  }\n};\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[144,144],"id":"c7c8f424-0b7b-4c39-9eeb-95dfd35bcea2","name":"HTTP Request"},{"parameters":{"operation":"toBinary","sourceProperty":"data.csvContent.fileContent","options":{}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[352,144],"id":"55640f6e-0de6-440e-be77-be56457c45a1","name":"Convert to File"},{"parameters":{"operation":"text","options":{}},"type":"n8n-nodes-base.extractFromFile","typeVersion":1,"position":[560,144],"id":"da0acb11-d7b0-43ed-8c2b-0954f28f0045","name":"Extract from File"},{"parameters":{"content":"### a voir si on peut extraire en csv direct  au du binaire ou texte","height":288},"type":"n8n-nodes-base.stickyNote","position":[320,-160],"typeVersion":1,"id":"1af1eada-0aac-408d-bf75-7273cd90f392","name":"Sticky Note"}],"connections":{"When clicking ‚ÄòExecute workflow‚Äô":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Convert to File","type":"main","index":0}]]},"Convert to File":{"main":[[{"node":"Extract from File","type":"main","index":0}]]},"Extract from File":{"main":[[]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"HTTP Request":[{"json":{"data":{"success":true,"message":"CSV t√©l√©charg√© avec succ√®s","csvContent":{"fileContent":"Zm91cm5pc3NldXI7ZXRjb2RhO2Vhbjtwcm9kdWl0O25iIG1vaXMgc3RvY2s7c3RvY2s7Y2RlIGVuIGNvdXJzO21veS4gdmVudGVzO3ZlbnRlIG1vaXM7TSAtMTtNIC0yO00gLTM7TSAtNDtNIC01O00gLTYKVEVESVM7Q09POzM0MDA5Mzc5NzczNzE7QU1MT0RJUElORSBCSU9HIDEwTUcgR0VMIEIvMzA7MiwyNzswOzExMDs0OC4wOzA7MDszODs2Njs1NDs2Njs1NQpURURJUztDT087MzQwMDkzNzk3NzY2MTtBTUxPRElQSU5FIEJJT0cgNU1HIEdFTCBCLzMwOzMsODM7NjU7MzA7MjQuMDsxNTsyNTsyNjsxNzsxNzszOTszMwpURURJUztDT087MzQwMDkzNzk3NzQzMjtBTUxPRElQSU5FIEJJT0dBUkFOIDEwTUcgR0VMIEIvOTA7NCw0MDszOzMwOzcuMDsxMDsxMDs4OzI7MjsyNTs0ClRFRElTO0NPTzszNDAwOTM3OTc3NzIyO0FNTE9ESVBJTkUgQklPR0FSQU4gNU1HIEdFTCBCLzkwOzAsMDA7MDswOzAuMDswOzA7MDswOzA7MDswClRFRElTO0NPTzszNDAwOTMwMTM0MTUzO0FNTE9ESVBJTkUgVkFMU0FSVEFOIEJHUiA1LzgwTUcgQ1BSLzMwOzAsMDA7MDswOzAuMDswOzA7MDswOzA7MDswClRFRElTO0NPTzszNDAwOTM1NjQ0MjQ0O0FURU5PTE9MIEJJT0dBUkFOIDUwTUcgQ1BSIFNFQyBCLzMwOzIsNzM7MjU7MDs5LjA7Mjs0OzE1OzM7MTE7MTA7MTIKVEVESVM7Q09POzM0MDA5Mzc4NTE3NzA7QklDQUxVVEFNSURFIEJHUiA1ME1HIENQUiBQRUxMIEIvMzA7Miw2ODszMjszMDsyMy4wOzI2OzI0OzI2OzI0OzM1OzE2OzIzClRFRElTO0NPTzszNDAwOTM0NzcyMjgzO0JST01BWkVQQU0gQklPR0FSQU4gNk1HIENQUiBCLzMwOzAsMDA7MDswOzEwNi4wOzE7Nzs5MTA7MjExOzEzNzsxNzswClRFRElTO0NPTzszNDAwOTI3NjI2OTQ0O0NBUEVDSVRBQklORSBCSU9HQVJBTiA1MDBNRyBDUFIgQi8xMjA7Nyw1Nzs4OTswOzExLjA7MTQ7MjI7MTg7MTk7MTE7ODs4ClRFRElTO0NPTzszNDAwOTM4MDQ1Nzg5O0NFRklYSU1FIEJJT0cgMjAwTUcgQ1BSIFBFTEwgQi84OzcsMDQ7MDsyNDAwOzM0MC4wOzcwOzM5Mjs1MTg7NDc0OzU0ODsyOTY7NDg0ClRFRElTO0NPTzszNDAwOTMwMDAxMzMyO0NFTEVDT1hJQiBCR1IgMTAwTUcgR0VMIEIvMzA7OSwzNTsxNjszNDA7MzguMDs2Nzs1OTs1Njs0MTs1MTszODszMApURURJUztDT087MzQwMDkzMDAwMTM3MDtDRUxFQ09YSUIgQkdSIDIwME1HIEdFTCBCLzMwOzQsMTc7MDs4NDA7MjAxLjA7MDswOzQyNDsyNTA7MjU0OzIwMjsyMTEKVEVESVM7Q09POzM0MDA5MzU4MzU5NzA7Q0VMSVBST0xPTCBCSU9HQVJBTiAyMDBNRyBDUFIgQi8yODsyLDMwOzI4OzA7MTIuMDsxMzs5OzI1OzEwOzI0OzExOzExClRFRElTO0NPTzszNDAwOTM4NDk4MTM0O0NMQVJJVEhST01ZQ0lORSBCSU9HIDI1ME1HIENQUiBQRUxMIEIvMTA7NSw2MTs5OzIwOzUuMDsyOzY7Mzs4Ozc7MTA7OQpURURJUztDT087MzQwMDkzODQ5MTUwMDtDTEFSSVRIUk9NWUNJTkUgQklPRyA1MDBNRyBDUFIgUEVMTCBCLzEwOzQsOTM7MDsxMzY7MjcuMDszOzI2OzI1OzQwOzE5OzUwOzMzClRFRElTO0NPTzszNDAwOTQxOTk5MDMxO0RFU0xPUkFUQURJTkUgQkdSIDVNRyBDUFIgUEVMTCBCLzE1OzgsNjc7MDsyNDAwOzI3Ni4wOzA7MTI0OzM5MzszNDI7Mzg2OzQyNzs0NTIKVEVESVM7Q09POzM0MDA5MzAwNjAwODc7RE9NUEVSSURPTkUgQkdSIDEwTUcgQ1BSIFBFTEwgQi8yMDs3LDQ2OzA7NzY4OzEwMi4wOzA7MTIyOzk1OzEzOTsxMjg7MTQ2OzE0MwpURURJUztDT087MzQwMDkzMDA2NTUxODtEVVRBU1RFUklERSBCSU9HQVJBTiAwLDVNRyBDQVBTIE1PTExFLzMwOzEsNTk7MDs0MDsyNS4wOzA7MDswOzc7MzY7MjI7MjcKVEVESVM7Q09POzM0MDA5MzU0OTk2MjI7RU5BTEFQUklMIEJJT0dBUkFOIDIwTUcgQ1BSIEIvMjg7Nyw2NTswOzI0MDA7MzEzLjA7MTk1OzUxNjszNTE7MjgzOzI5MDsyMjA7MjA5ClRFRElTO0NPTzszNDAwOTM3NjU2MzEzO0lCVVBST0ZFTkUgQklPRyA0MDBNRyBDUFIgUEVMTCBCLzIwOzUsNTE7NTkwOzA7MTA3LjA7NDI7NTU7NjI7NDI7OTc7MTE2OzE1MgpURURJUztDT087MzQwMDkzODM1ODkyNjtJQlVQUk9GRU5FIEJJT0cgQ09OU0VJTCA0MDBNRyBDUFIgUEVMTDEwOzEyLDkxOzE5OTswOzE1LjA7MTU7MTU7MTc7OTsyMzsxMzsxNQpURURJUztDT087MzQwMDkyMjQ0NDI3NztJUkJFU0FSVEFOIEJJT0cgMTUwTUcgQ1BSIFBFTEwgQi8zMDs0LDAxOzA7MjEwOzUyLjA7MDswOzYwOzg5Ozc1OzExMDs1MgpURURJUztDT087MzQwMDkyMjQ0MzQ0NztJUkJFU0FSVEFOIEJJT0cgNzVNRyBDUFIgUEVMTCBCLzMwOzUsMTk7MDsxMDI7MTkuMDswOzI3OzIxOzE5OzE2OzM7MTQKVEVESVM7Q09POzM0MDA5MjI0NDUyMjk7SVJCRVNBUlRBTiBCSU9HQVJBTiAzMDBNRyBDUFIgUEVMTCBCLzMwOzMsNDI7MDs1NDY7MTU5LjA7MDstMTsyOTsyOTE7MjY1OzE4ODsxMzMKVEVESVM7Q09POzM0MDA5MjY4MzEzODc7SVJCRVNBUlRBTi9IQ1RaIEJJT0cgMzAwTUcvMTIsNU1HIENQUi8zMDsyLDg1OzA7ODA7MjguMDswOzA7Mzg7NDE7MzI7MzE7NDcKVEVESVM7Q09POzM0MDA5MjY4MzIyNzg7SVJCRVNBUlRBTi9IQ1RaIEJJT0dBUkFOMzAwTUcvMjVNRyBDUFIzMDsyLDcwOzA7NTA7MTguMDswOzA7MzU7MjU7MjQ7MTY7OQpURURJUztDT087MzQwMDkyMjE0MzM3ODtLRVRPUFJPRkVORSBCSU9HQVJBTiBMUCAxMDBNRyBDUFIgU0VDLzIwOzksMjM7NDg2OzE2MDA7MjI2LjA7MTAxOzMxNzsxNTY7Mzk1OzM4ODsyNTU7MjI0ClRFRElTO0NPTzszNDAwOTI3NTkzMDkzO0xBVEFOTy9USU1PTCBCSU9HNTBNQ0cvNU1HL01MIENPTEwvMiw1TUw7OCw1MzswOzE0MDsxNi4wOzQ7NTM7MTc7ODsxNDsyNDsxOApURURJUztDT087MzQwMDk0OTE4ODEyMztMRVRST1pPTEUgQkdSIDIsNU1HIENQUiBCLzMwOzMsNTc7MTM7ODA7MjYuMDsxNDsxMzsyNDsxOTs0MDsyOTszMQpURURJUztDT087MzQwMDk0MTY1NjcyOTtMRVZFVElSQUNFVEFNIEJJT0cxMDAwTUcgQ1BSIFBFTEwgU0VDLzYwOzcsMjA7MDszMDs0LjA7MDswOzA7MDswOzIzOzIKVEVESVM7Q09POzM0MDA5NDE2NTY5NTg7TEVWRVRJUkFDRVRBTSBCSU9HMjUwTUcgQ1BSIFBFTEwgU0VDLzYwOzYsODc7MDsxOTA7MjcuMDs5OzM0OzI4OzM1OzE5OzMwOzEyClRFRElTO0NPTzszNDAwOTQxNjU2Mzc4O0xFVkVUSVJBQ0VUQU0gQklPRzUwME1HIENQUiBQRUxMIFNFQy82MDs0LDY4OzA7Mjc2OzU5LjA7MDswOzI0OzU5Ozc5Ozg3OzUwClRFRElTO0NPTzszNDAwOTM5NzE4MzMwO01FVEZPUk1JTkUgQklPRyAxMDAwTUcgQ1BSIFBFTEwgQi8zMDsxMSw1MzswOzk2MDs4My4wOzU5OzE1Mjs4MjsxNDU7OTQ7NzE7OTUKVEVESVM7Q09POzM0MDA5Mzk3MTcyMTA7TUVURk9STUlORSBCSU9HIDUwME1HIENQUiBQRUxMIEIvMzA7OCwzNjswOzI3NjA7MzMwLjA7MDsyOTQ7Nzg4OzQ0OTszNzU7MjIwOzE0NwpURURJUztDT087MzQwMDkzOTcxNzk2ODtNRVRGT1JNSU5FIEJJT0cgODUwTUcgQ1BSIFBFTEwgQi8zMDs4LDYwOzA7NTUwOzYzLjA7Nzs4Nzs3NTs3OTs1NDs0NDs0NwpURURJUztDT087MzQwMDkzOTcxODYyMDtNRVRGT1JNSU5FIEJJT0dBUkFOIDEwMDBNRyBDUFIgQi85MDswLDAwOzA7MDswLjA7MDswOzA7MDswOzA7MApURURJUztDT087MzQwMDkzOTcxNzQ0OTtNRVRGT1JNSU5FIEJJT0dBUkFOIDUwME1HIENQUiBCLzkwOzAsMDA7MDswOzAuMDswOzA7MDswOzA7MDswClRFRElTO0NPTzszNDAwOTM5NzE4MTAxO01FVEZPUk1JTkUgQklPR0FSQU4gODUwTUcgQ1BSIEIvOTA7MCwwMDswOzA7MC4wOzA7MDswOzA7MDswOzAKVEVESVM7Q09POzM0MDA5Mzk3NDA5MTE7TkVCSVZPTE9MIEJJT0dBUkFOIDVNRyBDUFIgUVVBRFJJU0VDLzMwOzgsMTA7MDsxMzgwOzE3MC4wOzA7Mjc1OzE5MzsyMTY7MTU3OzE1NTsxNTQKVEVESVM7Q09POzM0MDA5MzAxNjgzOTQ7T01FUFJBWk9MRSBCSU9HQVJBTiAyME1HIEdFTCBHQVNUIEIvMTQ7Myw5NzswOzE5MDA7NDc4LjA7MDswOzEzODsxMDIxOzYxODs1ODQ7NTUwClRFRElTO0NPTzszNDAwOTMwMDM4NTM2O1BST1BSQU5PTE9MIEJJT0dBUkFOIDQwTUcgQ1BSIFNFQyBCLzUwOzcsNTM7MDsxMTI1OzE0OS4wOzA7MTU5OzMwNDsyMDY7MTQ0Ozk3OzEyOQpURURJUztDT087MzQwMDkzMDAxNjkzMDtSQUNFQ0FET1RSSUwgQklPRyAxMDBNRyBHRUwgQi8yMDsxNCw0MDsyOzEwOzAuMDswOy0yOzQ7MTswOzE7MApURURJUztDT087MzQwMDkzODE1OTc4MztSSVNQRVJJRE9ORSBCSU9HQVJBTiAxTUcgQ1BSIFBFTEwgU0VDLzYwOzYsNTA7MDsyMDA7MzAuMDswOzM3OzY5OzE4OzM2OzI4OzMyClRFRElTO0NPTzszNDAwOTM4MTYwMTU0O1JJU1BFUklET05FIEJJT0dBUkFOIDJNRyBDUFIgUEVMTCBTRUMvNjA7MywzMTsxMTk7MjIwOzEwMi4wOzgxOzExOTs5MDsxMzU7OTE7NDY7MTgzClRFRElTO0NPTzszNDAwOTI2ODgwNzA1O1NJTERFTkFGSUwgQklPRyAxMDBNRyBDUFIgUEVMTCBCLzg7NSwwNjs3MDs4MDsyOS4wOzU7NDQ7NDA7MjI7MjY7MTU7MjYKVEVESVM7Q09POzM0MDA5MzAwOTk3MTE7VEFEQUxBRklMIEJJT0dBUkFOIDEwTUcgQ1BSIFBFTEwgQi80OzUsOTU7MDsxMjA7MjAuMDswOzA7MDswOzU4OzM4OzE2ClRFRElTO0NPTzszNDAwOTMwMDk5NzQyO1RBREFMQUZJTCBCSU9HQVJBTiAyME1HIENQUiBQRUxMIEIvNDsyLDE1OzA7ODA7MzcuMDswOzA7MDswOzc7ODY7NDEKVEVESVM7Q09POzM0MDA5NDkyNDcxMjc7Wk9MTUlUUklQVEFOIEJJT0dBUkFOIDIsNU1HIENQUiBPUk9EIEIvNjszLDQ4OzA7MjA7NS4wOzA7MDswOzA7OTsxMTs5ClRFRElTO0NPTzszNDAwOTQ5MjQ3Mjk1O1pPTE1JVFJJUFRBTiBCSU9HQVJBTiAyLDVNRyBDUFIgT1JPRC8xMjs1LDM4OzA7NzA7MTMuMDswOzc7MzA7MTg7MTE7MTM7Mwo=","contentType":"text/csv;charset=ISO-8859-1","filename":"export-statsventes-globales.csv","size":4856},"currentUrl":"https://fournisseur-benin.ubipharm.com/StatsVentes"},"type":"application/json"}}]},"versionId":"266a5b8a-cb96-484d-9366-1a1ef9727ae4","triggerCount":1,"shared":[{"createdAt":"2025-09-24T12:49:54.044Z","updatedAt":"2025-09-24T12:49:54.044Z","role":"workflow:owner","workflowId":"isjhKyi99x2adke0","projectId":"TAg2OWp8a2XzOVPs"}],"tags":[]}